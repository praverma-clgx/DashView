# Global Teardown - How It Works

## ğŸ“‹ Overview

The global teardown system runs **automatically after ALL tests complete** to clean up sessions, authentication states, and generate summary reports.

## ğŸ”„ Execution Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. All Tests Complete                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Global Teardown Starts              â”‚
â”‚     ğŸ§¹ Teardown Started...              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Logout from All Sessions            â”‚
â”‚     ğŸšª Logging out...                   â”‚
â”‚     âœ“ Enterprise logout complete        â”‚
â”‚     âœ“ Admin logout complete             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Clean Authentication States         â”‚
â”‚     ğŸ” Cleaning auth states...          â”‚
â”‚     âœ“ Removed: enterprise.json          â”‚
â”‚     âœ“ Removed: admin.json               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. Generate Summary Report             â”‚
â”‚     ğŸ“Š Generating summary...            â”‚
â”‚     âœ“ Summary saved to:                 â”‚
â”‚       test-results/teardown-summary.jsonâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. Teardown Complete                   â”‚
â”‚     âœ… Complete! (2.34s)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ What Gets Cleaned

### 1. **Active Sessions** ğŸšª

- Opens headless browser with stored auth
- Navigates to app and clicks logout button
- Properly terminates both Admin and Enterprise sessions
- **Why?** Prevents session conflicts in next test run

### 2. **Authentication Files** ğŸ”

- Deletes `.auth/enterprise.json`
- Deletes `.auth/admin.json`
- Keeps `.auth/` directory structure
- **Why?** Forces fresh login on next run, prevents stale auth

### 3. **Summary Report** ğŸ“Š

- Creates `test-results/teardown-summary.json`
- Includes timestamp, environment, and actions taken
- **Why?** Audit trail for CI/CD and debugging

## ğŸš€ Usage

### Automatic (Recommended)

```bash
# Teardown runs automatically after tests
npm test
```

**Console Output:**

```
ğŸ§¹ Global Teardown Started...

ğŸšª Logging out from all sessions...
   âœ“ Enterprise logout complete
   âœ“ Admin logout complete
ğŸ” Cleaning up authentication states...
   âœ“ Removed: enterprise.json
   âœ“ Removed: admin.json
ğŸ“Š Generating teardown summary...
   âœ“ Summary saved to: test-results/teardown-summary.json

âœ… Global Teardown Complete! (2.34s)
```

### Manual Cleanup (Anytime)

```bash
# Clean all test artifacts manually
npm run cleanup
```

**What It Does:**

- âœ… Cleans `.auth/` contents (keeps folder)
- âœ… Removes `test-results/` completely
- âœ… Removes `playwright-report/` completely
- âœ… Removes `downloads/` completely

```bash
# Full cleanup (includes Playwright cache)
npm run cleanup:full
```

```bash
# Only remove reports (keep auth states)
npm run cleanup:reports
```

## ğŸ“ File Structure

```
DashUI_Framework/
â”œâ”€â”€ global-teardown.js           â† Main teardown logic
â”œâ”€â”€ playwright.config.js         â† References: globalTeardown: './global-teardown.js'
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ cleanup.js              â† Manual cleanup utility
â”œâ”€â”€ .auth/                      â† Cleaned by teardown
â”‚   â”œâ”€â”€ admin.json              â† Removed
â”‚   â””â”€â”€ enterprise.json         â† Removed
â””â”€â”€ test-results/
    â””â”€â”€ teardown-summary.json   â† Generated by teardown
```

## ğŸ”§ Configuration

### Enable/Disable Teardown

**In `playwright.config.js`:**

```javascript
export default defineConfig({
  globalSetup: './global-setup.js',
  globalTeardown: './global-teardown.js', // â† Comment out to disable
  // ...
});
```

### Customize Behavior

**In `global-teardown.js`:**

```javascript
// Skip logout (keep sessions active)
async function logoutAllSessions() {
  console.log('â­ Skipping logout (sessions preserved)');
  return;
}

// Keep auth states (don't delete)
async function cleanupAuthStates() {
  console.log('â­ Skipping auth cleanup (states preserved)');
  return;
}
```

## ğŸ¯ When Teardown Runs

| Command                        | Teardown Runs?      |
| ------------------------------ | ------------------- |
| `npm test`                     | âœ… YES              |
| `npm run test:admin`           | âœ… YES              |
| `npm run test:enterprise`      | âœ… YES              |
| `npm run test:ui`              | âœ… YES              |
| `npm run test:headed`          | âœ… YES              |
| `npx playwright test --headed` | âœ… YES              |
| `npx playwright test --debug`  | âŒ NO (debug mode)  |
| `npm run cleanup`              | âŒ NO (manual only) |

## ğŸ› Troubleshooting

### Issue: "Teardown takes too long"

**Solution:** Check network timeouts, sessions might be hanging

```javascript
// Reduce timeout in global-teardown.js
await enterprisePage.goto(config.enterprise.baseUrl, { timeout: 5000 }); // Reduced from 10000
```

### Issue: "Auth files not deleted"

**Solution:** File permissions issue

```bash
# Windows: Run as Administrator
npm test

# Check file permissions
icacls .auth\enterprise.json
```

### Issue: "Sessions not logging out"

**Solution:** Logout button locator changed

```javascript
// Update locators in respective page objects:
// - EnterpriseHomePageLocators.logoutButton
// - AdminHomePageLoc.LogoutBtn
```

### Issue: "Summary not generated"

**Solution:** `test-results/` folder permissions

```bash
# Create folder manually
mkdir test-results

# Or clean and recreate
npm run cleanup
npm test
```

## ğŸ“Š Summary Report Format

**File:** `test-results/teardown-summary.json`

```json
{
  "teardownCompleted": "2026-01-13T10:30:45.123Z",
  "environment": "dkirc",
  "testSuite": "DashUI Framework",
  "actions": {
    "sessionsLoggedOut": true,
    "authStatesRemoved": true,
    "cleanupSuccessful": true
  },
  "timestamp": 1705145445123
}
```

## ğŸ¯ Best Practices

1. âœ… **Always let teardown run** - Don't Ctrl+C during teardown
2. âœ… **Check teardown logs** - Look for warnings about failed logouts
3. âœ… **Use manual cleanup** - If you stop tests mid-run, use `npm run cleanup`
4. âœ… **Monitor summary reports** - Track teardown success in CI/CD
5. âš ï¸ **Don't modify .auth files manually** - Let setup/teardown manage them

## ğŸ”„ Lifecycle Summary

```
npm test
  â”‚
  â”œâ”€â–º Global Setup Runs (login, create .auth files)
  â”œâ”€â–º Tests Execute (use .auth files)
  â””â”€â–º Global Teardown Runs (logout, delete .auth files)
        â†“
      Ready for next test run (clean state)
```

## ğŸ“ Support

- **Error during teardown?** Check console output for specific error
- **Tests fail after teardown?** Run `npm run cleanup && npm test` to reset
- **CI/CD integration?** Teardown runs automatically in pipelines

---

**Last Updated:** January 13, 2026  
**Framework Version:** DashUI v1.0.0  
**Playwright Version:** ^1.56.1
